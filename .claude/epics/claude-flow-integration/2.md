---
name: Orchestrator Core - Build agent coordination and handoff logic
status: open
created: 2025-08-29T22:39:05Z
updated: 2025-08-30T20:27:17Z
github: https://github.com/microservice-tech/ccpm/issues/2
depends_on: [18, 6]
parallel: false
conflicts_with: []
---

# Task 2: Orchestrator Core - Build agent coordination and handoff logic

## Description

Build the central orchestrator system that manages the complete per-issue workflow execution within isolated environments. This component handles the orchestration of workspace creation, repository operations, local Claude Flow installation, hive-mind spawning with issue-specific prompts, implementation monitoring, PR creation, and cleanup.

The orchestrator ensures each issue runs in complete isolation with its own Claude Flow instance, preventing state contamination and enabling parallel processing. It implements sophisticated patterns for workflow management and provides robust error handling and recovery mechanisms for each stage of the issue implementation process.

## Acceptance Criteria

- [ ] Orchestrator class implements complete per-issue workflow
- [ ] Workspace isolation with unique paths per issue
- [ ] Repository cloning and branch creation automated
- [ ] Local Claude Flow installation per workspace
- [ ] Hive-mind spawn with formatted issue prompt
- [ ] Implementation progress monitoring
- [ ] Feedback loop handling for iterations
- [ ] Automated PR creation upon completion
- [ ] Complete workspace cleanup after PR
- [ ] Parallel issue processing without interference
- [ ] Error handling for each workflow stage
- [ ] Recovery mechanisms for partial failures
- [ ] Comprehensive logging of all operations
- [ ] Integration with state management system from task 9
- [ ] Unit tests with 90%+ coverage
- [ ] Performance tests using k6 for concurrent execution

## Technical Details

### Core Components

1. **Orchestrator Class**
   - Workspace lifecycle management
   - Repository operations (clone, branch, push)
   - Claude Flow installation orchestration
   - Hive-mind spawn with issue context
   - Implementation progress monitoring
   - PR creation automation
   - Workspace cleanup coordination
   - Parallel issue processing
   - Error recovery mechanisms

2. **Workflow Stages**
   ```python
   class IssueWorkflow:
       def create_workspace(issue_id)
       def clone_repository(workspace, repo_url)
       def create_branch(issue_id)
       def install_claude_flow(workspace)
       def spawn_hive_mind(issue_id, issue_title, issue_body)
       def monitor_implementation()
       def handle_feedback()
       def create_pull_request(issue_id, implementation_summary)
       def cleanup_workspace(workspace)
   ```

2. **Strategy Pattern Implementation**
   - Sequential execution strategy
   - Parallel execution strategy
   - Priority-based execution strategy
   - Custom workflow execution strategies

3. **Isolation Management**
   - Workspace path: `/tmp/claude-flow-issues/issue-{id}/`
   - Process isolation for concurrent issues
   - Resource cleanup guarantees
   - No shared state between issues
   - ExecuteAgentCommand implementation
   - HandoffCommand for agent transitions
   - Command queue and execution engine

4. **Handoff Mechanism**
   - State serialization/deserialization
   - Context preservation between agents
   - Validation of handoff requirements
   - Rollback capabilities for failed handoffs

### Architecture

```
orchestrator/
├── __init__.py
├── orchestrator.py          # Main orchestrator class
├── strategies/
│   ├── __init__.py
│   ├── base.py             # Base strategy interface
│   ├── sequential.py       # Sequential execution
│   ├── parallel.py         # Parallel execution
│   └── priority.py         # Priority-based execution
├── commands/
│   ├── __init__.py
│   ├── base.py             # Base command interface
│   ├── execute.py          # Agent execution commands
│   └── handoff.py          # Agent handoff commands
└── handoff/
    ├── __init__.py
    ├── manager.py          # Handoff coordination
    ├── serializer.py       # State serialization
    └── validator.py        # Handoff validation
```

### Key Features

- **Agent Pool Management**: Dynamic creation and cleanup of agent instances
- **State Preservation**: Seamless state transfer between agents
- **Error Recovery**: Automatic retry and rollback mechanisms
- **Performance Monitoring**: Detailed metrics and logging
- **Extensibility**: Easy addition of new execution strategies

## Dependencies

- **Task 6**: Service Foundation - Required for base service infrastructure
- **Task 9**: State Management - Required for workflow state handling
- **Task 11**: Agent Registry - Required for agent discovery and instantiation

## Effort Estimate

**Size**: Large (L)
**Estimated Hours**: 20 hours

### Breakdown:
- Orchestrator core design and implementation: 8 hours
- Strategy pattern implementation: 4 hours
- Command pattern implementation: 3 hours
- Handoff mechanism development: 3 hours
- Testing and documentation: 2 hours

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code follows project coding standards
- [ ] Unit tests implemented with 90%+ coverage
- [ ] Performance tests created and passing
- [ ] Integration tests with dependent tasks
- [ ] Docker containerization working
- [ ] Documentation updated
- [ ] Code review completed
- [ ] All tests passing in CI/CD pipeline
- [ ] Performance benchmarks established and met
